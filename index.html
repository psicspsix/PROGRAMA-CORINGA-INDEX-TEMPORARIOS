<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frases e Citações</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #1a1a1a; 
            color: #e0e0e0; 
            overflow-x: hidden; 
        }
        #loginScreen, #appScreen { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            box-sizing: border-box; 
        }
        #loginScreen { 
            background: url('https://images.unsplash.com/photo-1614730321146-b6fa6a46bcb4?q=80&w=1470&auto=format&fit=crop') no-repeat center center fixed; 
            background-size: cover; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column;
        }
        #appScreen { 
            display: none; 
            padding: 20px; 
            overflow-y: auto; 
            overflow-x: hidden; 
        }
        .login-container, .register-container { 
            background: rgba(0, 0, 0, 0.8); 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
        }
        .login-container input, .register-container input { 
            width: 100%; 
            max-width: 300px; 
            font-size: 18px; 
            padding: 10px; 
            margin: 10px 0; 
            background: #333; 
            color: #e0e0e0; 
            border: 1px solid #555; 
            border-radius: 5px; 
        }
        .login-container button, .register-container button { 
            font-size: 18px; 
            padding: 10px 20px; 
            margin: 5px; 
            background: #333; 
            color: #e0e0e0; 
            border: 1px solid #555; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .login-container button:hover, .register-container button:hover { 
            background: #555; 
        }
        #registerContainer { 
            display: none; 
            margin-top: 20px; 
        }
        #message { 
            color: #ff5555; 
            margin-top: 10px; 
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            max-width: 100%; 
            margin-bottom: 60px; 
        }
        h1 { 
            margin: 0; 
            color: #ffffff; 
        }
        .menu { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        button { 
            font-size: 18px; 
            padding: 10px; 
            margin: 5px; 
            background: #333; 
            color: #e0e0e0; 
            border: 1px solid #555; 
            cursor: pointer; 
        }
        button:hover { 
            background: #555; 
        }
        button.active { 
            background: #555; 
            font-weight: bold; 
        }
        .small-btn { 
            font-size: 14px; 
            padding: 5px; 
            width: 30px; 
            height: 30px; 
            line-height: 20px; 
            text-align: center; 
        }
        ul { 
            list-style-type: none; 
            padding: 0; 
        }
        li { 
            font-size: 18px; 
            margin: 10px 0; 
            background: #2a2a2a; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .prompt-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .adv-prompt-details { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        textarea { 
            width: 100%; 
            background: #444; 
            color: #e0e0e0; 
            border: 1px solid #555; 
            padding: 5px; 
            box-sizing: border-box; 
            font-size: 20px; 
        }
        textarea::placeholder { 
            font-size: 20px; 
            color: #888; 
        }
        #error, #success { 
            text-align: center; 
        }
        #error { 
            color: #ff5555; 
        }
        #success { 
            color: #55ff55; 
        }
        .input-row { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            align-items: flex-start; 
        }
        #phraseText, #editPhraseText { 
            height: 150px; 
        }
        #phraseContext, #editPhraseContext { 
            height: 100px; 
        }
        .location-note-container { 
            display: flex; 
            flex-direction: row; 
            gap: 10px; 
            width: 100%; 
        }
        #phraseLocation, #editPhraseLocation, #phraseNote, #editPhraseNote { 
            height: 50px; 
            width: 50%; 
        }
        #phraseAuthor, #editPhraseAuthor { 
            width: 33.33%; 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            font-size: 20px; 
        }
        #phraseUserEmail, #editPhraseUserEmail { 
            width: 25%; 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            font-size: 20px; 
        }
        #searchPhraseAuthor { 
            width: 33.33%; 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            font-size: 20px; 
        }
        #advSearchPhraseAuthor, #advSearchPhraseUserEmail { 
            width: calc(66% + 50mm); 
            height: 100px; 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            font-size: 20px; 
            box-sizing: border-box; 
        }
        #phraseAuthor.admin, #editPhraseAuthor.admin { 
            width: 25%; 
        }
        #phraseAuthor::placeholder, #editPhraseAuthor::placeholder, #searchPhraseAuthor::placeholder, 
        #phraseUserEmail::placeholder, #editPhraseUserEmail::placeholder, 
        #advSearchPhraseAuthor::placeholder, #advSearchPhraseUserEmail::placeholder { 
            font-size: 20px; 
            color: #888; 
        }
        #categorySelect, #editCategorySelect { 
            padding: 10px; 
            background: #333; 
            color: #e0e0e0; 
            border: 1px solid #555; 
            height: 100px; 
            width: 33.33%; 
        }
        #categorySelect.admin, #editCategorySelect.admin { 
            width: 50%; 
        }
        #categoryName { 
            width: 33.33%; 
            background: #000; 
            color: #fff; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 5px; 
            font-size: 20px; 
        }
        #categoryName::placeholder { 
            font-size: 20px; 
            color: #888; 
        }
        #txtOutput, #txtOutputAdv { 
            display: none; 
            margin: 10px 0; 
            padding: 10px; 
            background: #333; 
            border-radius: 5px; 
            width: 100%; 
            min-height: 100px; 
            resize: vertical; 
        }
        .search-container { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .combo-box { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            width: 33%; 
        }
        .combo-box select { 
            height: 200px; 
            background: #000; 
            color: #fff; 
            border: 1px solid #555; 
            width: 100%; 
        }
        #searchInput, #advSearchInput { 
            width: 100%; 
            font-size: 18px; 
            padding: 10px; 
            background: #000; 
            color: #fff; 
            border: 1px solid #555; 
            border-radius: 5px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
        }
        .prompt-container { 
            display: flex; 
            flex-direction: row; 
            gap: 10px; 
            width: 100%; 
            justify-content: flex-start; 
        }
        .adv-search-author-container { 
            display: flex; 
            flex-direction: column; 
            gap: 0px; 
            width: calc(66% + 50mm); 
        }
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        #hiddenCheckbox, #advSearchHiddenCheckbox, #editHiddenCheckbox, #searchAllPhrasesCheckbox { 
            width: 20px; 
            height: 20px; 
        }
        .category-list, .user-list { 
            margin-top: 50px; 
        }
        .search-btn-small { 
            padding: 5px 10px; 
            font-size: 16px; 
            width: auto; 
            align-self: flex-start; 
        }
        #importScreen textarea { 
            width: 100%; 
            height: 200px; 
            resize: vertical; 
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <h2>Frases e Citações</h2>
            <input type="text" id="userInput" placeholder="Usuário (e-mail)">
            <input type="password" id="passwordInput" placeholder="Senha">
            <button id="loginBtn">Entrar</button>
            <button id="registerBtn">Cadastrar</button>
            <button id="recoverBtn">Recuperar Senha</button>
            <div id="message"></div>
            <div id="registerContainer" class="register-container">
                <input type="text" id="newUserInput" placeholder="Novo Usuário (e-mail)">
                <input type="password" id="newPasswordInput" placeholder="Nova Senha">
                <button id="submitRegisterBtn">Cadastrar</button>
            </div>
        </div>
    </div>
    <div id="appScreen">
        <div class="header">
            <h1>Frases e Citações</h1>
            <div class="menu">
                <button id="storePhraseBtn">Cadastro de Frase</button>
                <button id="categoryBtn">Cadastro de Categoria</button>
                <button id="importBtn">Importações</button>
                <button id="searchBtn">Pesquisa</button>
                <button id="advancedSearchBtn" style="display: none;">Pesquisa Avançada</button>
                <button id="authorizationBtn" style="display: none;">Autorizações</button>
            </div>
        </div>
        <div id="mainContent">
            <div id="recentPhrases">
                <h2>Últimas Frases Armazenadas</h2>
                <ul id="phraseList"></ul>
                <button id="backBtn" style="display: none;">Voltar</button>
            </div>
            <div id="storePhraseScreen" style="display: none;">
                <div class="input-row">
                    <textarea id="phraseText" placeholder="Digite a frase ou citação"></textarea>
                    <textarea id="phraseContext" placeholder="Descreva o contexto no qual ela pode ser ou foi empregada"></textarea>
                    <div class="location-note-container">
                        <textarea id="phraseLocation" placeholder="Locais em que você já a utilizou"></textarea>
                        <textarea id="phraseNote" placeholder="Digite as palavras-chaves"></textarea>
                    </div>
                    <div class="prompt-container" id="storePhraseContainer">
                        <input type="text" id="phraseAuthor" placeholder="Nome do Autor">
                        <input type="text" id="phraseUserEmail" placeholder="E-mail do Usuário" style="display: none;">
                        <select id="categorySelect" multiple></select>
                    </div>
                    <div class="checkbox-container">
                        <button id="savePhraseBtn">Salvar Frase</button>
                        <div id="hiddenCheckboxContainer" style="display: none;">
                            <input type="checkbox" id="hiddenCheckbox">
                            <label for="hiddenCheckbox">Oculto</label>
                        </div>
                    </div>
                </div>
                <button id="backBtnStore">Voltar</button>
            </div>
            <div id="editPhraseScreen" style="display: none;">
                <div class="input-row">
                    <textarea id="editPhraseText" placeholder="Digite a frase ou citação"></textarea>
                    <textarea id="editPhraseContext" placeholder="Descreva o contexto no qual ela pode ser ou foi empregada"></textarea>
                    <div class="location-note-container">
                        <textarea id="editPhraseLocation" placeholder="Locais em que você já a utilizou"></textarea>
                        <textarea id="editPhraseNote" placeholder="Digite as palavras-chaves"></textarea>
                    </div>
                    <div class="prompt-container">
                        <input type="text" id="editPhraseAuthor" placeholder="Nome do Autor">
                        <input type="text" id="editPhraseUserEmail" placeholder="E-mail do Usuário">
                        <select id="editCategorySelect" multiple></select>
                    </div>
                    <div class="checkbox-container">
                        <button id="saveEditPhraseBtn">Salvar Alterações</button>
                        <div id="editHiddenCheckboxContainer" style="display: none;">
                            <input type="checkbox" id="editHiddenCheckbox">
                            <label for="editHiddenCheckbox">Oculto</label>
                        </div>
                    </div>
                </div>
                <button id="backBtnEdit">Voltar</button>
            </div>
            <div id="categoryScreen" style="display: none;">
                <div class="input-row">
                    <input type="text" id="categoryName" placeholder="Nome da Categoria">
                    <textarea id="categoryDesc" placeholder="Breve descrição da categoria"></textarea>
                    <button id="saveCategoryBtn">Cadastrar Categoria</button>
                </div>
                <button id="backBtnCategory">Voltar</button>
                <div class="category-list">
                    <h3>Categorias já cadastradas</h3>
                    <ul id="categoryList"></ul>
                </div>
            </div>
            <div id="importScreen" style="display: none;">
                <div class="input-row">
                    <button id="importSameLineBtn">Importação por arquivo TXT com autor no mesmo parágrafo</button>
                    <button id="importSameLineNoteBtn">Importar por campo de nota</button>
                    <textarea id="importSameLineNote" style="display: none;"></textarea>
                    <button id="submitSameLineNote" style="display: none;">Incluir frases e citações</button>
                    <button id="importNextLineBtn">Importação por arquivo TXT com o autor em outra linha</button>
                    <button id="importNextLineNoteBtn">Importar por campo de nota</button>
                    <textarea id="importNextLineNote" style="display: none;"></textarea>
                    <button id="submitNextLineNote" style="display: none;">Incluir frases e citações</button>
                </div>
                <button id="backBtnImport">Voltar</button>
            </div>
            <div id="searchScreen" style="display: none;">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Digite o texto para pesquisa">
                    <button id="doSearchBtnTop" class="search-btn-small">Pesquisar</button>
                    <div class="input-row">
                        <textarea id="searchPhraseText" placeholder="Digite a frase ou citação"></textarea>
                        <textarea id="searchPhraseContext" placeholder="Descreva o contexto no qual ela pode ser ou foi empregada"></textarea>
                        <div class="location-note-container">
                            <textarea id="searchPhraseLocation" placeholder="Locais em que você já a utilizou"></textarea>
                            <textarea id="searchPhraseNote" placeholder="Digite as palavras-chaves"></textarea>
                        </div>
                        <div class="prompt-container">
                            <input type="text" id="searchPhraseAuthor" placeholder="Nome do Autor">
                            <div class="combo-box">
                                <label>Incluir Categorias:</label>
                                <select id="includeCategories" multiple></select>
                            </div>
                            <div class="combo-box">
                                <label>Excluir Categorias:</label>
                                <select id="excludeCategories" multiple></select>
                            </div>
                        </div>
                        <div id="searchAllPhrasesCheckboxContainer" class="checkbox-container" style="display: none;">
                            <input type="checkbox" id="searchAllPhrasesCheckbox">
                            <label for="searchAllPhrasesCheckbox">Pesquisar nas frases de todos os usuários</label>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <button id="doSearchBtn" class="search-btn-small">Pesquisar</button>
                        <button id="clearSearchBtn" class="search-btn-small">Limpar Campos</button>
                    </div>
                </div>
                <button id="txtSearchBtn">TXT</button>
                <textarea id="txtOutput" placeholder="Resultados da pesquisa aparecerão aqui"></textarea>
                <ul id="searchResults"></ul>
                <button id="backBtnSearch">Voltar</button>
            </div>
            <div id="advancedSearchScreen" style="display: none;">
                <div class="search-container">
                    <input type="text" id="advSearchInput" placeholder="Digite o texto para pesquisa avançada">
                    <button id="doAdvSearchBtnTop" class="search-btn-small">Pesquisar</button>
                    <div class="input-row">
                        <textarea id="advSearchPhraseText" placeholder="Digite a frase ou citação"></textarea>
                        <textarea id="advSearchPhraseContext" placeholder="Descreva o contexto no qual ela pode ser ou foi empregada"></textarea>
                        <div class="location-note-container">
                            <textarea id="advSearchPhraseLocation" placeholder="Locais em que você já a utilizou"></textarea>
                            <textarea id="advSearchPhraseNote" placeholder="Digite as palavras-chaves"></textarea>
                        </div>
                        <div class="prompt-container">
                            <div class="adv-search-author-container">
                                <input type="text" id="advSearchPhraseAuthor" placeholder="Nome do Autor">
                                <input type="text" id="advSearchPhraseUserEmail" placeholder="E-mail do Usuário">
                            </div>
                            <div class="combo-box">
                                <label>Incluir Categorias:</label>
                                <select id="advIncludeCategories" multiple></select>
                            </div>
                            <div class="combo-box">
                                <label>Excluir Categorias:</label>
                                <select id="advExcludeCategories" multiple></select>
                            </div>
                        </div>
                        <div id="advSearchHiddenCheckboxContainer" class="checkbox-container" style="display: none;">
                            <input type="checkbox" id="advSearchHiddenCheckbox">
                            <label for="advSearchHiddenCheckbox">Incluir Ocultos</label>
                        </div>
                    </div>
                    <div class="checkbox-container">
                        <button id="doAdvSearchBtn" class="search-btn-small">Pesquisar</button>
                        <button id="clearAdvSearchBtn" class="search-btn-small">Limpar Campos</button>
                    </div>
                </div>
                <button id="txtAdvSearchBtn">TXT</button>
                <textarea id="txtOutputAdv" placeholder="Resultados da pesquisa avançada aparecerão aqui"></textarea>
                <ul id="advSearchResults"></ul>
                <button id="backBtnAdvSearch">Voltar</button>
            </div>
            <div id="authorizationScreen" style="display: none;">
                <h2>Autorizações</h2>
                <div class="user-list">
                    <h3>Usuários Cadastrados</h3>
                    <ul id="userList"></ul>
                </div>
                <button id="backBtnAuthorization">Voltar</button>
            </div>
        </div>
        <div id="error"></div>
        <div id="success"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, update, set, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDRpR_8BzOWgWLZwbHGH1YStyaB_PjrO6U",
            authDomain: "gerenciador-de-frases-citacoes.firebaseapp.com",
            projectId: "gerenciador-de-frases-citacoes",
            storageBucket: "gerenciador-de-frases-citacoes.firebasestorage.app",
            messagingSenderId: "464800861207",
            appId: "1:464800861207:web:5632eee79acf2dbc606052",
            measurementId: "G-7FLQXET8S4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const phrasesRef = ref(db, 'phrases');
        const categoriesRef = ref(db, 'categories');
        const usersRef = ref(db, 'users');
        let currentUserEmail = null;
        let editingPhraseKey = null;
        let canSearchAllPhrases = false;

        function log(message) {
            console.log(`[LOG ${new Date().toLocaleTimeString()}]: ${message}`);
        }

        log("Firebase conectado com sucesso!");

        // Tela de Login e Autenticação
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const recoverBtn = document.getElementById('recoverBtn');
        const registerContainer = document.getElementById('registerContainer');
        const submitRegisterBtn = document.getElementById('submitRegisterBtn');
        const userInput = document.getElementById('userInput');
        const passwordInput = document.getElementById('passwordInput');
        const newUserInput = document.getElementById('newUserInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const messageDiv = document.getElementById('message');
        const searchBtn = document.getElementById('searchBtn');
        const advancedSearchBtn = document.getElementById('advancedSearchBtn');
        const authorizationBtn = document.getElementById('authorizationBtn');

        signOut(auth).then(() => {
            log("Logout inicial realizado para garantir tela de login");
            loginScreen.style.display = 'flex';
            appScreen.style.display = 'none';
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                log(`Usuário autenticado: ${currentUserEmail}`);
                const userRef = ref(db, `users/${user.uid}`);
                onValue(userRef, (snapshot) => {
                    const userData = snapshot.val();
                    canSearchAllPhrases = userData?.canSearchAllPhrases || false;
                    if (canSearchAllPhrases && currentUserEmail !== "psics.psix.141@gmail.com") {
                        document.getElementById('searchAllPhrasesCheckboxContainer').style.display = 'flex';
                    } else {
                        document.getElementById('searchAllPhrasesCheckboxContainer').style.display = 'none';
                    }
                }, { onlyOnce: true });

                if (currentUserEmail === "psics.psix.141@gmail.com") {
                    searchBtn.style.display = 'none';
                    advancedSearchBtn.style.display = 'inline-block';
                    authorizationBtn.style.display = 'inline-block';
                    document.getElementById('hiddenCheckboxContainer').style.display = 'flex';
                    document.getElementById('advSearchHiddenCheckboxContainer').style.display = 'flex';
                    document.getElementById('editHiddenCheckboxContainer').style.display = 'flex';
                    document.getElementById('phraseUserEmail').style.display = 'inline-block';
                    document.getElementById('phraseAuthor').classList.add('admin');
                    document.getElementById('categorySelect').classList.add('admin');
                } else {
                    searchBtn.style.display = 'inline-block';
                    advancedSearchBtn.style.display = 'none';
                    authorizationBtn.style.display = 'none';
                    document.getElementById('hiddenCheckboxContainer').style.display = 'none';
                    document.getElementById('advSearchHiddenCheckboxContainer').style.display = 'none';
                    document.getElementById('editHiddenCheckboxContainer').style.display = 'none';
                    document.getElementById('phraseUserEmail').style.display = 'none';
                    document.getElementById('phraseAuthor').classList.remove('admin');
                    document.getElementById('categorySelect').classList.remove('admin');
                }
                loginScreen.style.display = 'none';
                appScreen.style.display = 'block';
                showRecentPhrases();
            } else {
                currentUserEmail = null;
                canSearchAllPhrases = false;
                loginScreen.style.display = 'flex';
                appScreen.style.display = 'none';
                searchBtn.style.display = 'inline-block';
                advancedSearchBtn.style.display = 'none';
                authorizationBtn.style.display = 'none';
            }
        });

        loginBtn.addEventListener('click', loginUser);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginUser();
        });

        function loginUser() {
            const email = userInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                messageDiv.textContent = "Preencha todos os campos!";
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then(() => log("Login bem-sucedido"))
                .catch((error) => {
                    if (error.code === 'auth/user-not-found') {
                        messageDiv.textContent = "Favor cadastrar-se primeiro clicando no botão abaixo!";
                    } else if (error.code === 'auth/wrong-password') {
                        messageDiv.textContent = "Senha incorreta, favor tentar novamente!";
                    } else {
                        messageDiv.textContent = "Erro ao entrar: " + error.message;
                    }
                    log(`Erro ao fazer login: ${error.message}`);
                });
        }

        registerBtn.addEventListener('click', () => {
            registerContainer.style.display = 'block';
            messageDiv.textContent = '';
        });

        submitRegisterBtn.addEventListener('click', () => {
            const newEmail = newUserInput.value.trim();
            const newPassword = newPasswordInput.value.trim();
            if (!newEmail || !newPassword) {
                messageDiv.textContent = "Preencha todos os campos!";
                return;
            }
            createUserWithEmailAndPassword(auth, newEmail, newPassword)
                .then((userCredential) => {
                    const user = userCredential.user;
                    set(ref(db, `users/${user.uid}`), {
                        email: newEmail,
                        password: newPassword,
                        canSearchAllPhrases: false
                    }).then(() => {
                        messageDiv.textContent = "Usuário cadastrado com sucesso!";
                        registerContainer.style.display = 'none';
                        newUserInput.value = '';
                        newPasswordInput.value = '';
                    });
                })
                .catch((error) => {
                    messageDiv.textContent = "Erro ao cadastrar: " + error.message;
                    log(`Erro ao cadastrar usuário: ${error.message}`);
                });
        });

        recoverBtn.addEventListener('click', () => {
            const email = userInput.value.trim();
            if (!email) {
                messageDiv.textContent = "Digite seu e-mail para recuperação!";
                return;
            }
            sendPasswordResetEmail(auth, email)
                .then(() => {
                    messageDiv.textContent = "E-mail de recuperação enviado com sucesso!";
                })
                .catch((error) => {
                    messageDiv.textContent = "Erro ao enviar e-mail de recuperação: " + error.message;
                    log(`Erro ao enviar e-mail de recuperação: ${error.message}`);
                });
        });

        // Funções do Aplicativo
        function showScreen(screenId) {
            document.querySelectorAll('#mainContent > div').forEach(div => div.style.display = 'none');
            document.getElementById(screenId).style.display = 'block';
            document.getElementById('error').textContent = '';
            document.getElementById('success').textContent = '';
        }

        function loadCategories(selectElement, selectedCategories = []) {
            onValue(categoriesRef, (snapshot) => {
                const categories = snapshot.val();
                selectElement.innerHTML = '';
                if (categories) {
                    const sortedCategories = Object.entries(categories).sort((a, b) => a[1].name.localeCompare(b[1].name));
                    sortedCategories.forEach(([key, category]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = category.name;
                        if (selectedCategories.includes(category.name)) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                }
            }, { onlyOnce: true });
        }

        function showRecentPhrases() {
            showScreen('recentPhrases');
            onValue(phrasesRef, (snapshot) => {
                const phrases = snapshot.val();
                const phraseList = document.getElementById('phraseList');
                phraseList.innerHTML = '';
                if (!phrases) {
                    phraseList.innerHTML = '<li>Nenhuma frase armazenada ainda.</li>';
                    return;
                }
                let userPhrases;
                if (currentUserEmail === "psics.psix.141@gmail.com") {
                    userPhrases = Object.entries(phrases)
                        .sort((a, b) => b[1].timestamp - a[1].timestamp)
                        .slice(0, 10);
                } else {
                    userPhrases = Object.entries(phrases)
                        .filter(([_, phrase]) => phrase.userEmail === currentUserEmail)
                        .sort((a, b) => b[1].timestamp - a[1].timestamp)
                        .slice(0, 10);
                }
                userPhrases.forEach(([key, phrase]) => {
                    const categoriesText = Array.isArray(phrase.categories) ? phrase.categories.join(', ') : 'Sem categorias';
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="prompt-row">
                            <span>${phrase.text} | Autor: ${phrase.author} | Categorias: ${categoriesText}</span>
                            <button class="copy-btn" data-text="${encodeURIComponent(phrase.text)}">Copiar</button>
                            ${currentUserEmail === "psics.psix.141@gmail.com" ? `
                                <button class="edit-btn" data-key="${key}">Editar</button>
                                <button class="delete-btn" data-key="${key}">Excluir</button>
                            ` : ''}
                        </div>
                    `;
                    phraseList.appendChild(li);
                    li.querySelector('.copy-btn').addEventListener('click', (e) => {
                        const text = decodeURIComponent(e.target.getAttribute('data-text'));
                        navigator.clipboard.writeText(text);
                        document.getElementById('success').textContent = "Frase copiada para a área de transferência!";
                    });
                    if (currentUserEmail === "psics.psix.141@gmail.com") {
                        li.querySelector('.edit-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            editPhrase(key);
                        });
                        li.querySelector('.delete-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            deletePhrase(key, false);
                        });
                    }
                });
            }, { onlyOnce: true });
        }

        document.getElementById('storePhraseBtn').addEventListener('click', () => {
            showScreen('storePhraseScreen');
            loadCategories(document.getElementById('categorySelect'));
            document.getElementById('phraseUserEmail').value = currentUserEmail;
        });

        document.getElementById('savePhraseBtn').addEventListener('click', () => {
            const text = document.getElementById('phraseText').value.trim();
            const context = document.getElementById('phraseContext').value.trim();
            const location = document.getElementById('phraseLocation').value.trim();
            const note = document.getElementById('phraseNote').value.trim();
            let author = document.getElementById('phraseAuthor').value.trim();
            const userEmail = document.getElementById('phraseUserEmail').value.trim();
            const categorySelect = document.getElementById('categorySelect');
            const categories = Array.from(categorySelect.selectedOptions).map(option => option.textContent) || [];
            const hidden = currentUserEmail === "psics.psix.141@gmail.com" && document.getElementById('hiddenCheckbox').checked;

            if (!text) {
                document.getElementById('error').textContent = "Preencha o campo obrigatório: Texto da Frase!";
                return;
            }

            if (!author) {
                author = "Desconhecido";
            }

            const newPhrase = {
                text,
                context,
                location,
                note,
                author,
                userEmail: userEmail || currentUserEmail,
                categories: categories.length > 0 ? categories : [],
                timestamp: Date.now(),
                hidden: hidden || false
            };

            push(phrasesRef, newPhrase)
                .then(() => {
                    document.getElementById('success').textContent = "Frase armazenada com sucesso!";
                    document.getElementById('phraseText').value = '';
                    document.getElementById('phraseContext').value = '';
                    document.getElementById('phraseLocation').value = '';
                    document.getElementById('phraseNote').value = '';
                    document.getElementById('phraseAuthor').value = '';
                    document.getElementById('phraseUserEmail').value = currentUserEmail;
                    categorySelect.selectedIndex = -1;
                    if (hidden) document.getElementById('hiddenCheckbox').checked = false;
                })
                .catch(error => log(`Erro ao armazenar frase: ${error.message}`));
        });

        document.getElementById('categoryBtn').addEventListener('click', () => {
            showScreen('categoryScreen');
            loadCategoryList();
            const saveBtn = document.getElementById('saveCategoryBtn');
            saveBtn.textContent = "Cadastrar Categoria";
            saveBtn.removeEventListener('click', editCategoryHandler);
            saveBtn.addEventListener('click', saveCategoryDefault);
        });

        function saveCategoryDefault() {
            const name = document.getElementById('categoryName').value.trim();
            const desc = document.getElementById('categoryDesc').value.trim();
            if (!name || !desc) {
                document.getElementById('error').textContent = "Preencha todos os campos!";
                return;
            }
            push(categoriesRef, { name, description: desc })
                .then(() => {
                    document.getElementById('success').textContent = "Categoria cadastrada com sucesso!";
                    document.getElementById('categoryName').value = '';
                    document.getElementById('categoryDesc').value = '';
                    loadCategoryList();
                })
                .catch(error => log(`Erro ao cadastrar categoria: ${error.message}`));
        }

        function editCategoryHandler() {
            const name = document.getElementById('categoryName').value.trim();
            const desc = document.getElementById('categoryDesc').value.trim();
            const key = this.dataset.key;
            if (!name || !desc) {
                document.getElementById('error').textContent = "Preencha todos os campos!";
                return;
            }
            set(ref(db, `categories/${key}`), { name, description: desc })
                .then(() => {
                    document.getElementById('success').textContent = "Categoria alterada com sucesso!";
                    document.getElementById('categoryName').value = '';
                    document.getElementById('categoryDesc').value = '';
                    const saveBtn = document.getElementById('saveCategoryBtn');
                    saveBtn.textContent = "Cadastrar Categoria";
                    saveBtn.removeEventListener('click', editCategoryHandler);
                    saveBtn.addEventListener('click', saveCategoryDefault);
                    loadCategoryList();
                })
                .catch(error => log(`Erro ao alterar categoria: ${error.message}`));
        }

        document.getElementById('categoryName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('saveCategoryBtn').click();
        });

        document.getElementById('categoryDesc').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('saveCategoryBtn').click();
        });

        function loadCategoryList() {
            const categoryList = document.getElementById('categoryList');
            onValue(categoriesRef, (snapshot) => {
                const categories = snapshot.val();
                categoryList.innerHTML = '';
                if (!categories) {
                    categoryList.innerHTML = '<li>Nenhuma categoria cadastrada.</li>';
                    return;
                }
                const sortedCategories = Object.entries(categories).sort((a, b) => a[1].name.localeCompare(b[1].name));
                sortedCategories.forEach(([key, category]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="prompt-row">
                            <span>${category.name} | ${category.description}</span>
                            ${currentUserEmail === "psics.psix.141@gmail.com" ? `
                                <button class="edit-category-btn" data-key="${key}">Alterar</button>
                                <button class="delete-category-btn" data-key="${key}">Excluir</button>
                            ` : ''}
                        </div>
                    `;
                    categoryList.appendChild(li);
                    if (currentUserEmail === "psics.psix.141@gmail.com") {
                        li.querySelector('.edit-category-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            editCategory(key);
                        });
                        li.querySelector('.delete-category-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            deleteCategory(key);
                        });
                    }
                });
            }, { onlyOnce: true });
        }

        function editCategory(key) {
            const categoryRef = ref(db, `categories/${key}`);
            onValue(categoryRef, (snapshot) => {
                const category = snapshot.val();
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDesc').value = category.description;
                const saveBtn = document.getElementById('saveCategoryBtn');
                saveBtn.textContent = "Alterar Categoria";
                saveBtn.removeEventListener('click', saveCategoryDefault);
                saveBtn.dataset.key = key;
                saveBtn.addEventListener('click', editCategoryHandler);
                document.getElementById('categoryScreen').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, { onlyOnce: true });
        }

        function deleteCategory(key) {
            if (confirm("Tem certeza que deseja excluir esta categoria?")) {
                const categoryRef = ref(db, `categories/${key}`);
                remove(categoryRef)
                    .then(() => {
                        document.getElementById('success').textContent = "Categoria excluída com sucesso!";
                        loadCategoryList();
                    })
                    .catch(error => log(`Erro ao excluir categoria: ${error.message}`));
            }
        }

        document.getElementById('importBtn').addEventListener('click', () => {
            showScreen('importScreen');
            document.getElementById('importSameLineNote').style.display = 'none';
            document.getElementById('submitSameLineNote').style.display = 'none';
            document.getElementById('importNextLineNote').style.display = 'none';
            document.getElementById('submitNextLineNote').style.display = 'none';
        });

        document.getElementById('importSameLineBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        importPhrasesSameLine(content);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        document.getElementById('importSameLineNoteBtn').addEventListener('click', () => {
            const note = document.getElementById('importSameLineNote');
            const submitBtn = document.getElementById('submitSameLineNote');
            note.style.display = 'block';
            submitBtn.style.display = 'block';
            note.value = '';
        });

        document.getElementById('submitSameLineNote').addEventListener('click', () => {
            const content = document.getElementById('importSameLineNote').value.trim();
            if (content) {
                importPhrasesSameLine(content);
                document.getElementById('importSameLineNote').value = '';
            } else {
                document.getElementById('error').textContent = "Digite algo no campo de nota para importar!";
            }
        });

        function importPhrasesSameLine(content) {
            const paragraphs = content.split(/\n\s*\n/).filter(p => p.trim());
            paragraphs.forEach(paragraph => {
                const trimmed = paragraph.trim();
                const lastDotIndex = trimmed.lastIndexOf('.');
                let text, author;
                if (lastDotIndex !== -1 && lastDotIndex < trimmed.length - 1) {
                    text = trimmed.substring(0, lastDotIndex + 1).trim();
                    author = trimmed.substring(lastDotIndex + 1).trim();
                } else {
                    text = trimmed;
                    author = "Desconhecido";
                }
                const newPhrase = {
                    text,
                    context: '',
                    location: '',
                    note: '',
                    author,
                    userEmail: currentUserEmail,
                    categories: [],
                    timestamp: Date.now(),
                    hidden: false
                };
                push(phrasesRef, newPhrase)
                    .catch(error => log(`Erro ao importar frase: ${error.message}`));
            });
            document.getElementById('success').textContent = `${paragraphs.length} frases importadas com sucesso!`;
        }

        document.getElementById('importNextLineBtn').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        importPhrasesNextLine(content);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        });

        document.getElementById('importNextLineNoteBtn').addEventListener('click', () => {
            const note = document.getElementById('importNextLineNote');
            const submitBtn = document.getElementById('submitNextLineNote');
            note.style.display = 'block';
            submitBtn.style.display = 'block';
            note.value = '';
        });

        document.getElementById('submitNextLineNote').addEventListener('click', () => {
            const content = document.getElementById('importNextLineNote').value.trim();
            if (content) {
                importPhrasesNextLine(content);
                document.getElementById('importNextLineNote').value = '';
            } else {
                document.getElementById('error').textContent = "Digite algo no campo de nota para importar!";
            }
        });

        function importPhrasesNextLine(content) {
            const blocks = content.split(/\n\s*\n/).filter(b => b.trim());
            let count = 0;
            blocks.forEach(block => {
                const lines = block.split('\n').filter(line => line.trim());
                if (lines.length >= 1) {
                    const text = lines[0].trim();
                    const author = lines.length > 1 && lines[1].trim() ? lines[1].trim() : "Desconhecido";
                    const newPhrase = {
                        text,
                        context: '',
                        location: '',
                        note: '',
                        author,
                        userEmail: currentUserEmail,
                        categories: [],
                        timestamp: Date.now(),
                        hidden: false
                    };
                    push(phrasesRef, newPhrase)
                        .then(() => count++)
                        .catch(error => log(`Erro ao importar frase: ${error.message}`));
                }
            });
            document.getElementById('success').textContent = `${count} frases importadas com sucesso!`;
        }

        document.getElementById('searchBtn').addEventListener('click', () => {
            showScreen('searchScreen');
            loadCategories(document.getElementById('includeCategories'));
            loadCategories(document.getElementById('excludeCategories'));
            document.getElementById('searchAllPhrasesCheckbox').checked = false;
        });

        document.getElementById('advancedSearchBtn').addEventListener('click', () => {
            showScreen('advancedSearchScreen');
            loadCategories(document.getElementById('advIncludeCategories'));
            loadCategories(document.getElementById('advExcludeCategories'));
            if (currentUserEmail === "psics.psix.141@gmail.com") {
                document.getElementById('advSearchHiddenCheckbox').checked = false;
            }
        });

        document.getElementById('authorizationBtn').addEventListener('click', () => {
            showScreen('authorizationScreen');
            loadUserList();
        });

        function loadUserList() {
            const userList = document.getElementById('userList');
            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();
                userList.innerHTML = '';
                if (!users) {
                    userList.innerHTML = '<li>Nenhum usuário cadastrado.</li>';
                    return;
                }
                const sortedUsers = Object.entries(users).sort((a, b) => a[1].email.localeCompare(b[1].email));
                sortedUsers.forEach(([uid, user]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="prompt-row">
                            <span>${user.email}</span>
                            <div class="checkbox-container">
                                <input type="checkbox" id="perm_${uid}" ${user.canSearchAllPhrases ? 'checked' : ''}>
                                <label for="perm_${uid}">Permissão para pesquisar todas as frases</label>
                                ${user.email !== "psics.psix.141@gmail.com" ? `<button class="delete-user-btn" data-uid="${uid}">Excluir</button>` : ''}
                            </div>
                        </div>
                    `;
                    userList.appendChild(li);
                    li.querySelector(`#perm_${uid}`).addEventListener('change', (e) => {
                        set(ref(db, `users/${uid}/canSearchAllPhrases`), e.target.checked)
                            .then(() => log(`Permissão atualizada para ${user.email}`))
                            .catch(error => log(`Erro ao atualizar permissão: ${error.message}`));
                    });
                    if (user.email !== "psics.psix.141@gmail.com") {
                        li.querySelector('.delete-user-btn').addEventListener('click', (e) => {
                            const uid = e.target.getAttribute('data-uid');
                            deleteUser(uid);
                        });
                    }
                });
            }, { onlyOnce: true });
        }

        function deleteUser(uid) {
            if (confirm("Tem certeza que deseja excluir este usuário? Isso também excluirá todas as suas frases.")) {
                const userRef = ref(db, `users/${uid}`);
                const userPhrasesRef = ref(db, 'phrases');
                onValue(userPhrasesRef, (snapshot) => {
                    const phrases = snapshot.val();
                    if (phrases) {
                        const userPhrases = Object.entries(phrases).filter(([_, phrase]) => phrase.userEmail === currentUserEmail);
                        userPhrases.forEach(([key, _]) => {
                            remove(ref(db, `phrases/${key}`));
                        });
                    }
                }, { onlyOnce: true });
                remove(userRef)
                    .then(() => {
                        document.getElementById('success').textContent = "Usuário e suas frases excluídos com sucesso!";
                        loadUserList();
                    })
                    .catch(error => log(`Erro ao excluir usuário: ${error.message}`));
            }
        }

        function performSearch(isAdvanced = false) {
            const input = document.getElementById(isAdvanced ? 'advSearchInput' : 'searchInput').value.trim().toLowerCase();
            const phraseText = document.getElementById(isAdvanced ? 'advSearchPhraseText' : 'searchPhraseText').value.trim().toLowerCase();
            const phraseContext = document.getElementById(isAdvanced ? 'advSearchPhraseContext' : 'searchPhraseContext').value.trim().toLowerCase();
            const phraseLocation = document.getElementById(isAdvanced ? 'advSearchPhraseLocation' : 'searchPhraseLocation').value.trim().toLowerCase();
            const phraseNote = document.getElementById(isAdvanced ? 'advSearchPhraseNote' : 'searchPhraseNote').value.trim().toLowerCase();
            const phraseAuthor = document.getElementById(isAdvanced ? 'advSearchPhraseAuthor' : 'searchPhraseAuthor').value.trim().toLowerCase();
            const phraseUserEmail = isAdvanced ? document.getElementById('advSearchPhraseUserEmail').value.trim().toLowerCase() : '';
            const includeSelect = document.getElementById(isAdvanced ? 'advIncludeCategories' : 'includeCategories');
            const excludeSelect = document.getElementById(isAdvanced ? 'advExcludeCategories' : 'excludeCategories');
            const includeCategories = Array.from(includeSelect.selectedOptions).map(opt => opt.textContent);
            const excludeCategories = Array.from(excludeSelect.selectedOptions).map(opt => opt.textContent);
            const includeHidden = isAdvanced && currentUserEmail === "psics.psix.141@gmail.com" && document.getElementById('advSearchHiddenCheckbox').checked;
            const searchAllPhrases = !isAdvanced && canSearchAllPhrases && document.getElementById('searchAllPhrasesCheckbox').checked;
            const resultsList = document.getElementById(isAdvanced ? 'advSearchResults' : 'searchResults');

            if (includeCategories.length > 0 && excludeCategories.length > 0 && includeCategories.some(cat => excludeCategories.includes(cat))) {
                document.getElementById('error').textContent = "Conflito nas categorias! Marque apenas em uma coluna.";
                return;
            }

            onValue(phrasesRef, (snapshot) => {
                const phrases = snapshot.val();
                resultsList.innerHTML = '';
                if (!phrases) {
                    resultsList.innerHTML = '<li>Nenhuma frase encontrada.</li>';
                    scrollToResults(isAdvanced);
                    return;
                }

                const hasCriteria = input || phraseText || phraseContext || phraseLocation || phraseNote || phraseAuthor || (isAdvanced && phraseUserEmail) || includeCategories.length > 0 || excludeCategories.length > 0;

                const filteredPhrases = Object.entries(phrases)
                    .filter(([_, phrase]) => {
                        if (!isAdvanced && !searchAllPhrases && phrase.userEmail !== currentUserEmail) return false;
                        if (!isAdvanced && phrase.hidden && phrase.userEmail === "psics.psix.141@gmail.com") return false;
                        if (isAdvanced && currentUserEmail !== "psics.psix.141@gmail.com" && phrase.hidden) return false;

                        if (isAdvanced && includeHidden && !hasCriteria) {
                            return phrase.hidden && phrase.userEmail === "psics.psix.141@gmail.com";
                        }

                        if (!hasCriteria && !includeHidden) return false;

                        const generalMatch = !input || (
                            phrase.text.toLowerCase().includes(input) ||
                            (phrase.context && phrase.context.toLowerCase().includes(input)) ||
                            (phrase.location && phrase.location.toLowerCase().includes(input)) ||
                            (phrase.note && phrase.note.toLowerCase().includes(input)) ||
                            phrase.author.toLowerCase().includes(input) ||
                            (phrase.categories && phrase.categories.some(cat => cat.toLowerCase().includes(input))) ||
                            phrase.userEmail.toLowerCase().includes(input)
                        );

                        const specificMatch = (
                            (!phraseText || phrase.text.toLowerCase().includes(phraseText)) &&
                            (!phraseContext || (phrase.context && phrase.context.toLowerCase().includes(phraseContext))) &&
                            (!phraseLocation || (phrase.location && phrase.location.toLowerCase().includes(phraseLocation))) &&
                            (!phraseNote || (phrase.note && phrase.note.toLowerCase().includes(phraseNote))) &&
                            (!phraseAuthor || phrase.author.toLowerCase().includes(phraseAuthor)) &&
                            (!phraseUserEmail || phrase.userEmail.toLowerCase().includes(phraseUserEmail))
                        );

                        const includeMatch = includeCategories.length === 0 || (Array.isArray(phrase.categories) && phrase.categories.some(cat => includeCategories.includes(cat)));
                        const excludeMatch = excludeCategories.length === 0 || !(Array.isArray(phrase.categories) && phrase.categories.some(cat => excludeCategories.includes(cat)));

                        if (isAdvanced && includeHidden && hasCriteria) {
                            return generalMatch && specificMatch && includeMatch && excludeMatch;
                        }

                        if (phrase.hidden && phrase.userEmail === "psics.psix.141@gmail.com" && !includeHidden) return false;

                        return generalMatch && specificMatch && includeMatch && excludeMatch;
                    })
                    .sort((a, b) => b[1].timestamp - a[1].timestamp);

                filteredPhrases.forEach(([key, phrase]) => {
                    const categoriesText = Array.isArray(phrase.categories) ? phrase.categories.join(', ') : 'Sem categorias';
                    const li = document.createElement('li');
                    if (isAdvanced) {
                        li.innerHTML = `
                            <div class="prompt-row">
                                <div class="adv-prompt-details">
                                    <span>Texto: ${phrase.text}</span>
                                    <span>Contexto: ${phrase.context || ''}</span>
                                    <span>Local: ${phrase.location || ''}</span>
                                    <span>Palavras-chave: ${phrase.note || ''}</span>
                                    <span>Autor: ${phrase.author}</span>
                                    <span>E-mail: ${phrase.userEmail}</span>
                                    <span>Categorias: ${categoriesText}</span>
                                </div>
                                <button class="copy-btn" data-text="${encodeURIComponent(phrase.text)}">Copiar</button>
                                <button class="edit-btn" data-key="${key}">Editar</button>
                                ${currentUserEmail === "psics.psix.141@gmail.com" ? `<button class="delete-btn" data-key="${key}">Excluir</button>` : ''}
                            </div>
                        `;
                    } else {
                        li.innerHTML = `
                            <div class="prompt-row">
                                <span>${phrase.text} | Autor: ${phrase.author}</span>
                                <button class="copy-btn" data-text="${encodeURIComponent(phrase.text)}">Copiar</button>
                                ${currentUserEmail === "psics.psix.141@gmail.com" ? `
                                    <button class="edit-btn" data-key="${key}">Editar</button>
                                    <button class="delete-btn" data-key="${key}">Excluir</button>
                                ` : ''}
                            </div>
                        `;
                    }
                    resultsList.appendChild(li);
                    li.querySelector('.copy-btn').addEventListener('click', (e) => {
                        const text = decodeURIComponent(e.target.getAttribute('data-text'));
                        navigator.clipboard.writeText(text);
                        document.getElementById('success').textContent = "Frase copiada para a área de transferência!";
                    });
                    if (currentUserEmail === "psics.psix.141@gmail.com") {
                        li.querySelector('.edit-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            editPhrase(key);
                        });
                        li.querySelector('.delete-btn').addEventListener('click', (e) => {
                            const key = e.target.getAttribute('data-key');
                            deletePhrase(key, isAdvanced);
                        });
                    }
                });

                if (filteredPhrases.length === 0) {
                    resultsList.innerHTML = '<li>Nenhuma frase encontrada.</li>';
                } else {
                    document.getElementById('success').textContent = "Resultados exibidos!";
                }
                scrollToResults(isAdvanced);
            }, { onlyOnce: true });
        }

        function scrollToResults(isAdvanced) {
            const resultsList = document.getElementById(isAdvanced ? 'advSearchResults' : 'searchResults');
            resultsList.scrollIntoView({ behavior: 'smooth' });
        }

        function clearSearchFields(isAdvanced = false) {
            log(`Limpando campos da ${isAdvanced ? 'Pesquisa Avançada' : 'Pesquisa'} para ${currentUserEmail}`);
            const prefix = isAdvanced ? 'advSearch' : 'search';

            const clearValue = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                    log(`Campo ${id} limpo`);
                } else {
                    log(`Campo ${id} não encontrado`);
                }
            };

            const clearSelect = (id) => {
                const element = document.getElementById(id);
                if (element) {
                    element.selectedIndex = -1;
                    for (let option of element.options) {
                        option.selected = false;
                    }
                    log(`Combo box ${id} limpo`);
                } else {
                    log(`Combo box ${id} não encontrado`);
                }
            };

            clearValue(`${prefix}Input`);
            clearValue(`${prefix}PhraseText`);
            clearValue(`${prefix}PhraseContext`);
            clearValue(`${prefix}PhraseLocation`);
            clearValue(`${prefix}PhraseNote`);
            clearValue(`${prefix}PhraseAuthor`);
            if (isAdvanced) clearValue('advSearchPhraseUserEmail');

            clearSelect(isAdvanced ? 'advIncludeCategories' : 'includeCategories');
            clearSelect(isAdvanced ? 'advExcludeCategories' : 'excludeCategories');

            if (!isAdvanced && canSearchAllPhrases && currentUserEmail !== "psics.psix.141@gmail.com") {
                const checkbox = document.getElementById('searchAllPhrasesCheckbox');
                if (checkbox) {
                    checkbox.checked = false;
                    log("Checkbox searchAllPhrasesCheckbox limpo");
                }
            }

            if (isAdvanced && currentUserEmail === "psics.psix.141@gmail.com") {
                const hiddenCheckbox = document.getElementById('advSearchHiddenCheckbox');
                if (hiddenCheckbox) {
                    hiddenCheckbox.checked = false;
                    log("Checkbox advSearchHiddenCheckbox limpo");
                }
            }

            const results = document.getElementById(isAdvanced ? 'advSearchResults' : 'searchResults');
            const txtOutput = document.getElementById(isAdvanced ? 'txtOutputAdv' : 'txtOutput');
            if (results) {
                results.innerHTML = '';
                log(`Resultados ${isAdvanced ? 'advSearchResults' : 'searchResults'} limpos`);
            }
            if (txtOutput) {
                txtOutput.style.display = 'none';
                log(`Saída de texto ${isAdvanced ? 'txtOutputAdv' : 'txtOutput'} ocultada`);
            }

            document.getElementById('success').textContent = "Campos limpos com sucesso!";
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const screen = document.getElementById(isAdvanced ? 'advancedSearchScreen' : 'searchScreen');
            screen.style.display = 'none';
            setTimeout(() => {
                screen.style.display = 'block';
            }, 0);

            log("Campos limpos com sucesso");
        }

        function editPhrase(key) {
            showScreen('editPhraseScreen');
            const phraseRef = ref(db, `phrases/${key}`);
            onValue(phraseRef, (snapshot) => {
                const phrase = snapshot.val();
                if (!phrase) {
                    document.getElementById('error').textContent = "Frase não encontrada!";
                    return;
                }
                document.getElementById('editPhraseText').value = phrase.text;
                document.getElementById('editPhraseContext').value = phrase.context || '';
                document.getElementById('editPhraseLocation').value = phrase.location || '';
                document.getElementById('editPhraseNote').value = phrase.note || '';
                document.getElementById('editPhraseAuthor').value = phrase.author;
                document.getElementById('editPhraseUserEmail').value = phrase.userEmail;
                loadCategories(document.getElementById('editCategorySelect'), phrase.categories || []);
                if (currentUserEmail === "psics.psix.141@gmail.com") {
                    document.getElementById('editHiddenCheckbox').checked = phrase.hidden || false;
                }
                editingPhraseKey = key;
            }, { onlyOnce: true });
        }

        function deletePhrase(key, isAdvanced) {
            if (confirm("Tem certeza que deseja excluir esta frase?")) {
                const phraseRef = ref(db, `phrases/${key}`);
                remove(phraseRef)
                    .then(() => {
                        document.getElementById('success').textContent = "Frase excluída com sucesso!";
                        if (isAdvanced) {
                            performSearch(true);
                        } else {
                            showRecentPhrases();
                        }
                    })
                    .catch(error => log(`Erro ao excluir frase: ${error.message}`));
            }
        }

        document.getElementById('saveEditPhraseBtn').addEventListener('click', () => {
            const text = document.getElementById('editPhraseText').value.trim();
            const context = document.getElementById('editPhraseContext').value.trim();
            const location = document.getElementById('editPhraseLocation').value.trim();
            const note = document.getElementById('editPhraseNote').value.trim();
            let author = document.getElementById('editPhraseAuthor').value.trim();
            const userEmail = document.getElementById('editPhraseUserEmail').value.trim();
            const categorySelect = document.getElementById('editCategorySelect');
            const categories = Array.from(categorySelect.selectedOptions).map(option => option.textContent);
            const hidden = currentUserEmail === "psics.psix.141@gmail.com" && document.getElementById('editHiddenCheckbox').checked;

            if (!text) {
                document.getElementById('error').textContent = "Preencha o campo obrigatório: Texto da Frase!";
                return;
            }

            if (!author) {
                author = "Desconhecido";
            }

            const updatedPhrase = {
                text,
                context,
                location,
                note,
                author,
                userEmail: userEmail || currentUserEmail,
                categories: categories.length > 0 ? categories : [],
                timestamp: Date.now(),
                hidden: hidden || false
            };

            set(ref(db, `phrases/${editingPhraseKey}`), updatedPhrase)
                .then(() => {
                    document.getElementById('success').textContent = "Frase atualizada com sucesso!";
                    editingPhraseKey = null;
                    showRecentPhrases();
                })
                .catch(error => log(`Erro ao atualizar frase: ${error.message}`));
        });

        document.getElementById('doSearchBtn').addEventListener('click', () => performSearch(false));
        document.getElementById('doSearchBtnTop').addEventListener('click', () => performSearch(false));
        document.getElementById('doAdvSearchBtn').addEventListener('click', () => performSearch(true));
        document.getElementById('doAdvSearchBtnTop').addEventListener('click', () => performSearch(true));
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch(false);
        });
        document.getElementById('advSearchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch(true);
        });

        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            log("Botão Limpar Campos da Pesquisa clicado");
            clearSearchFields(false);
        });
        document.getElementById('clearAdvSearchBtn').addEventListener('click', () => {
            log("Botão Limpar Campos da Pesquisa Avançada clicado");
            clearSearchFields(true);
        });

        function exportSearchToTxt(isAdvanced = false) {
            const resultsList = document.getElementById(isAdvanced ? 'advSearchResults' : 'searchResults');
            const txtOutput = document.getElementById(isAdvanced ? 'txtOutputAdv' : 'txtOutput');
            let content = '';
            resultsList.querySelectorAll('li').forEach(li => {
                if (isAdvanced) {
                    const details = li.querySelector('.adv-prompt-details');
                    if (details) {
                        const spans = details.querySelectorAll('span');
                        spans.forEach(span => {
                            content += `${span.textContent}\n`;
                        });
                        content += '\n';
                    }
                } else {
                    const text = li.querySelector('span').textContent;
                    content += `${text}\n\n`;
                }
            });
            txtOutput.value = content || 'Nenhum resultado para exportar.';
            txtOutput.style.display = 'block';
        }

        document.getElementById('txtSearchBtn').addEventListener('click', () => exportSearchToTxt(false));
        document.getElementById('txtAdvSearchBtn').addEventListener('click', () => exportSearchToTxt(true));

        document.getElementById('backBtn').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnStore').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnEdit').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnCategory').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnImport').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnSearch').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnAdvSearch').addEventListener('click', showRecentPhrases);
        document.getElementById('backBtnAuthorization').addEventListener('click', showRecentPhrases);

        showRecentPhrases();
    </script>
</body>
</html>
