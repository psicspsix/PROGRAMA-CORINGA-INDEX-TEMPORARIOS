<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Forca</title>
    <link rel="icon" href="https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/psicspsix.ico">
    <style>
        body {
            background-image: url('https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Forca.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        #telaInicial, #telaJogo {
            text-align: center;
            transition: all 0.3s ease;
        }
        #telaInicial {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 600px;
        }
        #telaInicial > div {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
        }
        #telaJogo {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            position: relative;
        }
        #telaJogo.chat-aberto {
            margin-left: -20%;
            max-width: 50%;
        }
        h1, h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        h3 {
            font-size: 2em;
            margin: 0;
        }
        button {
            background-color: #333333;
            color: #ffffff;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            pointer-events: auto;
            z-index: 1000;
        }
        button:hover {
            background-color: #555555;
        }
        #jogarSozinhoBtn {
            white-space: normal;
            line-height: 1.4;
            padding: 10px 15px;
            width: 180px;
            height: 50px;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        input, textarea {
            font-size: 1.2em;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            background: #333333;
            color: #ffffff;
            border: 1px solid #555555;
            width: calc(100% - 22px);
        }
        #letraInput {
            width: 50px;
            text-align: center;
        }
        textarea {
            resize: none;
            height: 60px;
            overflow-y: auto;
        }
        #forcaContainer {
            position: relative;
            width: 300px;
            height: 600px;
            margin: 20px auto;
            overflow: hidden;
            border: 2px solid #ffffff;
            background: rgba(0, 0, 0, 0.5);
        }
        #forcaImagem {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: clip-path 0.3s ease;
        }
        #erroImagem {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 16px;
            text-align: center;
            display: none;
        }
        #forcaImagem.erro-0 { clip-path: inset(100% 0 0 0); }
        #forcaImagem.erro-1 { clip-path: inset(0 0 80% 0); }
        #forcaImagem.erro-2 { clip-path: inset(0 0 60% 0); }
        #forcaImagem.erro-3 { clip-path: inset(0 0 50% 0); }
        #forcaImagem.erro-4 { clip-path: inset(0 0 40% 0); }
        #forcaImagem.erro-5 { clip-path: inset(0 0 20% 0); }
        #forcaImagem.erro-6 { clip-path: inset(0 0 0 0); }
        #palavra, #palavraJogador1 {
            font-size: 24px;
            margin: 20px 0;
        }
        #palavraTopo {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 24px;
        }
        #mensagem {
            font-size: 18px;
            color: #ffff00;
        }
        #mensagemLetraRepetida {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ff0000;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #exemploFrases {
            font-size: 16px;
            margin-top: 10px;
        }
        #placar {
            font-size: 16px;
            margin-top: 10px;
        }
        #jogador1View, #jogador2View {
            margin-bottom: 20px;
        }
        #participanteEsquerda, #participanteDireita {
            position: absolute;
            top: 120px;
            text-align: center;
            z-index: 1000;
        }
        #participanteEsquerda {
            left: -300px;
        }
        #participanteDireita {
            right: -300px;
        }
        #participanteEsquerda h3, #participanteDireita h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        #participanteEsquerda p, #participanteDireita p {
            font-size: 1.5em;
            margin: 0;
        }
        #chatContainer {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 30%;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            z-index: 999;
        }
        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #555555;
            border-radius: 5px;
        }
        #chatInputContainer {
            display: flex;
            flex-direction: column;
        }
        #chatBtn {
            background-color: #444444;
            padding: 10px 20px;
            z-index: 1000;
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
        }
        #closeChatBtn {
            background-color: #444444;
            padding: 10px 20px;
            z-index: 1000;
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: none;
        }
        #chatInput {
            resize: none;
            height: 60px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .mensagem {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
        }
        .mensagem.jogador1 {
            background-color: #555555;
            text-align: left;
        }
        .mensagem.jogador2 {
            background-color: #777777;
            text-align: right;
        }
        #botoesFimJogo {
            display: none;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        #botoesFimJogo button {
            padding: 10px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div id="telaInicial">
        <h1>Jogo de Forca</h1>
        <div>
            <button id="jogarSozinhoBtn">Jogar Sozinho (Palavras em Inglês)</button>
            <button id="jogarComAmigoBtn">Jogar com Amigo</button>
        </div>
        <div id="opcoesMultiplayer" style="display: none;">
            <button id="criarJogoBtn">Criar Jogo</button>
            <button id="entrarJogoBtn">Entrar em Jogo</button>
        </div>
        <div id="criarJogo" style="display: none;">
            <input type="text" id="palavraInput" placeholder="Digite a palavra">
            <button id="criarJogoSubmitBtn">Criar</button>
        </div>
        <div id="entrarJogo" style="display: none;">
            <input type="text" id="idJogoInput" placeholder="Digite o ID do jogo">
            <button id="entrarJogoSubmitBtn">Entrar</button>
        </div>
    </div>
    <div id="telaJogo">
        <p id="palavraTopo"></p>
        <div id="jogador1View" style="display: none;">
            <h2>Aguardando o amigo adivinhar...</h2>
            <p>Palavra: <span id="palavraJogador1"></span></p>
            <p>Letras já escolhidas: <span id="letrasAdivinhadasJogador1"></span></p>
        </div>
        <div id="jogador2View" style="display: none;">
            <h2>Adivinhe a palavra</h2>
            <p id="palavra"></p>
            <input type="text" id="letraInput" maxlength="1" placeholder="Digite uma letra">
        </div>
        <div id="participanteEsquerda">
            <h3 id="nomeEsquerda"></h3>
            <p id="pontosEsquerda"></p>
        </div>
        <div id="participanteDireita">
            <h3 id="nomeDireita"></h3>
            <p id="pontosDireita"></p>
        </div>
        <div id="forcaContainer">
            <img id="forcaImagem" src="https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo.jpg" alt="Imagem da forca" onload="console.log('Imagem carregada:', this.src); document.getElementById('erroImagem').style.display = 'none';" onerror="console.error('Erro ao carregar imagem:', this.src); document.getElementById('erroImagem').style.display = 'block';">
            <div id="erroImagem">Erro: Não foi possível carregar a imagem.</div>
        </div>
        <div id="mensagemLetraRepetida">Letra já digitada!</div>
        <p id="mensagem"></p>
        <p id="exemploFrases"></p>
        <p id="placar"></p>
        <div id="botoesFimJogo"></div>
    </div>
    <button id="chatBtn">Abrir Chat</button>
    <button id="closeChatBtn" style="display: none;">Fechar Chat</button>
    <div id="chatContainer">
        <div id="chatMessages"></div>
        <div id="chatInputContainer">
            <textarea id="chatInput" placeholder="Digite sua mensagem..."></textarea>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYju4ux-XrvEXaP2aSXbY2eJd_Qj4AKow",
            authDomain: "jogo-de-forca-b905b.firebaseapp.com",
            databaseURL: "https://jogo-de-forca-b905b-default-rtdb.firebaseio.com",
            projectId: "jogo-de-forca-b905b",
            storageBucket: "jogo-de-forca-b905b.firebasestorage.app",
            messagingSenderId: "18562245618",
            appId: "1:18562245618:web:f73368efe7b2b4a97fc16b",
            measurementId: "G-WMMXLXSY1R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let modo = '';
        let papel = '';
        let idJogo = '';
        let jogadorId = Math.random().toString(36).substr(2, 9);
        let jogo = {
            palavra: '',
            letrasAdivinhadas: [],
            erros: 0,
            estado: 'em andamento',
            frases: [],
            chatAberto: false,
            jogador1: '',
            jogador2: '',
            jogador1Inicial: '',
            jogador2Inicial: '',
            placar: {}
        };
        let unsubscribeJogo = null;
        let unsubscribeChat = null;
        const imagemOriginal = 'https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo.jpg';
        const imagemDerrota = 'https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo-Enforcado.jpg';

        function normalizarLetra(letra) {
            if (!letra) return letra;
            return letra.toLowerCase()
                .replace(/[áàâã]/g, 'a')
                .replace(/[éèê]/g, 'e')
                .replace(/[íìî]/g, 'i')
                .replace(/[óòôõ]/g, 'o')
                .replace(/[úùû]/g, 'u')
                .replace(/[ç]/g, 'c');
        }

        function normalizarPalavra(palavra) {
            return palavra.split('').map(normalizarLetra).join('');
        }

        function mostrarTela(tela) {
            const telaInicial = document.getElementById('telaInicial');
            const telaJogo = document.getElementById('telaJogo');
            const chatContainer = document.getElementById('chatContainer');
            const chatBtn = document.getElementById('chatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');

            telaInicial.style.display = 'none';
            telaJogo.style.display = 'none';
            chatContainer.style.display = 'none';
            chatBtn.style.display = 'none';
            closeChatBtn.style.display = 'none';

            if (tela === 'inicial') {
                telaInicial.style.display = 'flex';
                document.getElementById('opcoesMultiplayer').style.display = 'none';
                document.getElementById('criarJogo').style.display = 'none';
                document.getElementById('entrarJogo').style.display = 'none';
                if (unsubscribeJogo) unsubscribeJogo();
                if (unsubscribeChat) unsubscribeChat();
                jogo.placar = {};
            } else if (tela === 'jogo') {
                telaJogo.style.display = 'block';
                if (modo === 'multiplayer') {
                    chatBtn.style.display = jogo.chatAberto ? 'none' : 'block';
                    closeChatBtn.style.display = jogo.chatAberto ? 'block' : 'none';
                    chatContainer.style.display = jogo.chatAberto ? 'flex' : 'none';
                }
                if (papel === 'jogador2' && jogo.estado === 'em andamento') {
                    document.getElementById('letraInput').focus();
                }
            }
        }

        function mostrarOpcoesMultiplayer() {
            document.getElementById('opcoesMultiplayer').style.display = 'flex';
            document.getElementById('criarJogo').style.display = 'none';
            document.getElementById('entrarJogo').style.display = 'none';
        }

        function mostrarCriarJogo() {
            document.getElementById('opcoesMultiplayer').style.display = 'none';
            document.getElementById('criarJogo').style.display = 'block';
            document.getElementById('entrarJogo').style.display = 'none';
            document.getElementById('palavraInput').focus();
            document.getElementById('palavraInput').value = '';
        }

        function mostrarEntrarJogo() {
            document.getElementById('opcoesMultiplayer').style.display = 'none';
            document.getElementById('entrarJogo').style.display = 'block';
            document.getElementById('criarJogo').style.display = 'none';
            document.getElementById('idJogoInput').focus();
        }

        function atualizarInterfaceChat(chatAberto) {
            const telaJogo = document.getElementById('telaJogo');
            const chatContainer = document.getElementById('chatContainer');
            const chatBtn = document.getElementById('chatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const nomeEsquerda = document.getElementById('nomeEsquerda');
            const pontosEsquerda = document.getElementById('pontosEsquerda');
            const nomeDireita = document.getElementById('nomeDireita');
            const pontosDireita = document.getElementById('pontosDireita');

            if (chatAberto) {
                telaJogo.classList.add('chat-aberto');
                chatContainer.style.display = 'flex';
                chatBtn.style.display = 'none';
                closeChatBtn.style.display = 'block';
                nomeEsquerda.textContent = '';
                pontosEsquerda.textContent = '';
                nomeDireita.textContent = '';
                pontosDireita.textContent = '';
            } else {
                telaJogo.classList.remove('chat-aberto');
                chatContainer.style.display = 'none';
                chatBtn.style.display = 'block';
                closeChatBtn.style.display = 'none';
                if (modo === 'multiplayer') {
                    const idJogador1 = jogo.jogador1Inicial || jogo.jogador1;
                    const idJogador2 = jogo.jogador2Inicial || jogo.jogador2;
                    const vitoriasJ1 = jogo.placar[idJogador1] ? jogo.placar[idJogador1].vitorias : 0;
                    const vitoriasJ2 = jogo.placar[idJogador2] ? jogo.placar[idJogador2].vitorias : 0;
                    nomeEsquerda.textContent = 'Jogador 1';
                    pontosEsquerda.textContent = `Pontos: ${vitoriasJ1}`;
                    nomeDireita.textContent = 'Jogador 2';
                    pontosDireita.textContent = `Pontos: ${vitoriasJ2}`;
                }
            }
        }

        async function toggleChat() {
            const jogoRef = ref(db, `jogos/${idJogo}`);
            const snapshot = await get(jogoRef);
            if (snapshot.exists()) {
                const jogoAtual = snapshot.val();
                const novoEstadoChat = !jogoAtual.chatAberto;
                await update(jogoRef, { chatAberto: novoEstadoChat });
            } else {
                alert('Jogo não encontrado.');
            }
        }

        async function enviarMensagem() {
            const mensagem = document.getElementById('chatInput').value.trim();
            if (!mensagem) return;
            const chatRef = ref(db, `jogos/${idJogo}/chat`);
            await push(chatRef, {
                remetente: papel,
                texto: mensagem,
                timestamp: Date.now()
            });
            document.getElementById('chatInput').value = '';
            document.getElementById('chatInput').focus();
        }

        function exibirMensagens(snapshot) {
            const mensagens = snapshot.val();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            if (mensagens) {
                Object.values(mensagens)
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `mensagem ${msg.remetente}`;
                        div.textContent = `${msg.remetente.charAt(0).toUpperCase() + msg.remetente.slice(1)}: ${msg.texto}`;
                        chatMessages.appendChild(div);
                    });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        async function iniciarJogoSolo() {
            modo = 'solo';
            papel = 'jogador2';
            jogo.placar = { jogador: { vitorias: 0 }, computador: { vitorias: 0 } };
            await carregarNovaPalavra();
            mostrarTela('jogo');
            exibirJogo();
            document.getElementById('letraInput').focus();
        }

        async function jogarNovamente() {
            const imagemForca = document.getElementById('forcaImagem');
            imagemForca.src = imagemOriginal;
            imagemForca.className = 'erro-0';
            if (modo === 'solo') {
                await carregarNovaPalavra();
                exibirJogo();
                document.getElementById('letraInput').focus();
            } else if (modo === 'multiplayer') {
                const jogoRef = ref(db, `jogos/${idJogo}`);
                const snapshot = await get(jogoRef);
                if (!snapshot.exists()) {
                    alert('O jogo não existe mais.');
                    mostrarTela('inicial');
                    return;
                }
                const novoJogador1 = jogo.jogador2;
                const novoJogador2 = jogo.jogador1;
                const placarAtual = jogo.placar;
                jogo = validateJogo({
                    palavra: '',
                    letrasAdivinhadas: [],
                    erros: 0,
                    estado: 'aguardando_palavra',
                    frases: [],
                    chatAberto: false,
                    jogador1: novoJogador1,
                    jogador2: novoJogador2,
                    jogador1Inicial: jogo.jogador1Inicial || jogo.jogador1,
                    jogador2Inicial: jogo.jogador2Inicial || jogo.jogador2,
                    placar: placarAtual
                });
                await set(jogoRef, jogo);
                await set(ref(db, `jogos/${idJogo}/chat`), null);
                papel = jogadorId === novoJogador1 ? 'jogador1' : 'jogador2';
                if (papel === 'jogador1') {
                    mostrarTela('inicial');
                    mostrarCriarJogo();
                } else {
                    alert('Aguardando o Jogador 1 escolher uma nova palavra.');
                    mostrarTela('jogo');
                    exibirJogo();
                }
            }
        }

        async function carregarNovaPalavra() {
            const palavrasRef = ref(db, 'palavras');
            const snapshot = await get(palavrasRef);
            const palavras = snapshot.val();
            if (!palavras) {
                alert('Nenhuma palavra encontrada.');
                return;
            }
            const palavrasArray = Object.values(palavras);
            const palavraAleatoria = palavrasArray[Math.floor(Math.random() * palavrasArray.length)];
            const placarAtual = jogo.placar || { jogador: { vitorias: 0 }, computador: { vitorias: 0 } };
            jogo = {
                palavra: palavraAleatoria.palavra.toLowerCase(),
                letrasAdivinhadas: [],
                erros: 0,
                estado: 'em andamento',
                frases: palavraAleatoria.flexoes?.length > 0
                    ? [`Flexões: ${palavraAleatoria.flexoes.join(', ')}`]
                    : [`Frequência: ${palavraAleatoria.frequencia}`],
                chatAberto: false,
                jogador1: '',
                jogador2: '',
                jogador1Inicial: '',
                jogador2Inicial: '',
                placar: placarAtual
            };
            const imagemForca = document.getElementById('forcaImagem');
            imagemForca.src = imagemOriginal;
            imagemForca.className = 'erro-0';
        }

        async function criarJogo() {
            const palavra = document.getElementById('palavraInput').value.trim().toLowerCase();
            if (!palavra.match(/^[a-záéíóúâêîôûãõç]+$/)) {
                alert('Digite uma palavra válida (apenas letras).');
                return;
            }
            modo = 'multiplayer';
            papel = 'jogador1';
            idJogo = idJogo || generateUniqueId();
            const placarAtual = jogo.placar || {};
            if (!placarAtual[jogadorId]) placarAtual[jogadorId] = { vitorias: 0 };
            if (jogo.jogador2 && !placarAtual[jogo.jogador2]) placarAtual[jogo.jogador2] = { vitorias: 0 };
            jogo = {
                palavra: palavra,
                letrasAdivinhadas: [],
                erros: 0,
                estado: 'em andamento',
                frases: [`Você usou "${palavra}" em uma frase!`],
                chatAberto: false,
                jogador1: jogadorId,
                jogador2: jogo.jogador2 || '',
                jogador1Inicial: jogo.jogador1Inicial || jogadorId,
                jogador2Inicial: jogo.jogador2Inicial || jogo.jogador2,
                placar: placarAtual
            };
            const jogoRef = ref(db, `jogos/${idJogo}`);
            await set(jogoRef, jogo);
            alert(`Jogo criado! ID: ${idJogo}`);
            mostrarTela('jogo');
            exibirJogo();
            unsubscribeJogo = onValue(jogoRef, (snapshot) => {
                if (snapshot.exists()) {
                    jogo = validateJogo(snapshot.val());
                    papel = jogadorId === jogo.jogador1 ? 'jogador1' : 'jogador2';
                    if (jogo.estado === 'aguardando_palavra' && papel === 'jogador1') {
                        mostrarTela('inicial');
                        mostrarCriarJogo();
                    } else {
                        mostrarTela('jogo');
                        exibirJogo();
                        atualizarInterfaceChat(jogo.chatAberto);
                    }
                }
            });
            unsubscribeChat = onValue(ref(db, `jogos/${idJogo}/chat`), exibirMensagens);
        }

        function generateUniqueId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function validateJogo(data) {
            const placar = data.placar || {};
            if (data.jogador1 && !placar[data.jogador1]) placar[data.jogador1] = { vitorias: 0 };
            if (data.jogador2 && !placar[data.jogador2]) placar[data.jogador2] = { vitorias: 0 };
            return {
                palavra: data.palavra || '',
                letrasAdivinhadas: Array.isArray(data.letrasAdivinhadas) ? data.letrasAdivinhadas : [],
                erros: Number.isInteger(data.erros) ? data.erros : 0,
                estado: data.estado || 'em andamento',
                frases: Array.isArray(data.frases) ? data.frases : [`Jogo com ID ${idJogo}`],
                chatAberto: data.chatAberto || false,
                jogador1: data.jogador1 || '',
                jogador2: data.jogador2 || '',
                jogador1Inicial: data.jogador1Inicial || data.jogador1,
                jogador2Inicial: data.jogador2Inicial || data.jogador2,
                placar: placar
            };
        }

        async function entrarJogo() {
            const id = document.getElementById('idJogoInput').value.trim();
            if (!id) {
                alert('Digite um ID válido.');
                return;
            }
            modo = 'multiplayer';
            papel = 'jogador2';
            idJogo = id;
            const jogoRef = ref(db, `jogos/${idJogo}`);
            const snapshot = await get(jogoRef);
            if (snapshot.exists()) {
                jogo = validateJogo(snapshot.val());
                if (!jogo.placar[jogadorId]) jogo.placar[jogadorId] = { vitorias: 0 };
                if (!jogo.jogador2) {
                    jogo.jogador2 = jogadorId;
                    jogo.jogador2Inicial = jogo.jogador2Inicial || jogadorId;
                    await update(jogoRef, {
                        jogador2: jogadorId,
                        jogador2Inicial: jogo.jogador2Inicial,
                        placar: jogo.placar
                    });
                }
                mostrarTela('jogo');
                exibirJogo();
                unsubscribeJogo = onValue(jogoRef, (snapshot) => {
                    if (snapshot.exists()) {
                        jogo = validateJogo(snapshot.val());
                        papel = jogadorId === jogo.jogador1 ? 'jogador1' : 'jogador2';
                        if (jogo.estado === 'aguardando_palavra' && papel === 'jogador1') {
                            mostrarTela('inicial');
                            mostrarCriarJogo();
                        } else {
                            mostrarTela('jogo');
                            exibirJogo();
                            atualizarInterfaceChat(jogo.chatAberto);
                        }
                    } else {
                        alert('Jogo não encontrado.');
                        mostrarTela('inicial');
                    }
                });
                unsubscribeChat = onValue(ref(db, `jogos/${idJogo}/chat`), exibirMensagens);
            } else {
                alert('Jogo não encontrado.');
            }
        }

        function exibirJogo() {
            if (!jogo) return;
            const imagemForca = document.getElementById('forcaImagem');
            if (jogo.estado === 'perdido') {
                imagemForca.src = imagemDerrota;
                imagemForca.className = '';
            } else {
                imagemForca.src = imagemOriginal;
                imagemForca.className = `erro-${jogo.erros}`;
            }
            const palavraOculta = (jogo.estado === 'vencido' || jogo.estado === 'perdido')
                ? jogo.palavra
                : jogo.palavra.split('').map(letra => jogo.letrasAdivinhadas.some(l => normalizarLetra(l) === normalizarLetra(letra)) ? letra : '_').join(' ');
            document.getElementById('palavraTopo').textContent = (jogo.estado === 'vencido' || jogo.estado === 'perdido') ? `Palavra: ${jogo.palavra}` : '';
            if (papel === 'jogador1' && jogo.estado !== 'aguardando_palavra') {
                document.getElementById('jogador1View').style.display = 'block';
                document.getElementById('jogador2View').style.display = 'none';
                document.getElementById('palavraJogador1').textContent = palavraOculta;
                document.getElementById('letrasAdivinhadasJogador1').textContent = jogo.letrasAdivinhadas.join(', ');
            } else {
                document.getElementById('jogador1View').style.display = 'none';
                document.getElementById('jogador2View').style.display = 'block';
                document.getElementById('palavra').textContent = palavraOculta;
            }
            if (modo === 'multiplayer') {
                const idJogador1 = jogo.jogador1Inicial || jogo.jogador1;
                const idJogador2 = jogo.jogador2Inicial || jogo.jogador2;
                const vitoriasJ1 = jogo.placar[idJogador1]?.vitorias || 0;
                const vitoriasJ2 = jogo.placar[idJogador2]?.vitorias || 0;
                if (!jogo.chatAberto) {
                    document.getElementById('nomeEsquerda').textContent = 'Jogador 1';
                    document.getElementById('pontosEsquerda').textContent = `Pontos: ${vitoriasJ1}`;
                    document.getElementById('nomeDireita').textContent = 'Jogador 2';
                    document.getElementById('pontosDireita').textContent = `Pontos: ${vitoriasJ2}`;
                }
                document.getElementById('placar').textContent = (jogo.estado === 'vencido' || jogo.estado === 'perdido')
                    ? `Placar: Jogador 1 (${vitoriasJ1}) | Jogador 2 (${vitoriasJ2})`
                    : '';
            } else if (modo === 'solo') {
                const vitoriasJogador = jogo.placar.jogador?.vitorias || 0;
                const vitoriasComputador = jogo.placar.computador?.vitorias || 0;
                if (!jogo.chatAberto) {
                    document.getElementById('nomeEsquerda').textContent = 'Jogador';
                    document.getElementById('pontosEsquerda').textContent = `Pontos: ${vitoriasJogador}`;
                    document.getElementById('nomeDireita').textContent = 'Computador';
                    document.getElementById('pontosDireita').textContent = `Pontos: ${vitoriasComputador}`;
                }
                document.getElementById('placar').textContent = (jogo.estado === 'vencido' || jogo.estado === 'perdido')
                    ? `Placar: Jogador (${vitoriasJogador}) | Computador (${vitoriasComputador})`
                    : '';
            }
            const botoesFimJogo = document.getElementById('botoesFimJogo');
            const botoesHTML = `
                <button onclick="jogarNovamente()">Jogar Novamente</button>
                <button onclick="window.open('https://translate.google.com.br/?sl=auto&tl=pt&text=${encodeURIComponent(jogo.palavra)}%0A&op=translate', '_blank')">Mostrar Tradução da Palavra</button>
                <button onclick="window.open('https://www.reverso.net/tradu%C3%A7%C3%A3o-texto#sl=eng&tl=por&text=${encodeURIComponent(jogo.palavra)}%250A', '_blank')">Mostrar Palavra em Frases</button>
                <button onclick="window.open('https://www.ccaa.com.br/blog/expressoes-em-ingles/', '_blank')">35 Expressões CCAA</button>
                <button onclick="window.open('https://www.wizard.com.br/idiomas/20-expressoes-em-ingles-mais-usadas-em-uma-conversa/', '_blank')">20 Expressões Wizard</button>
                <button onclick="window.open('https://fisk.com.br/blog/20-expressoes-idiomaticas-em-ingles', '_blank')">20 Expressões Fisk</button>
                <button onclick="window.open('https://www.ef.com.br/guia-de-ingles/expressoes-idiomaticas-em-ingles/', '_blank')">Expressões EF Brasil</button>
                <button onclick="window.open('https://www.youtube.com/watch?v=BIAITFJ8uTI&t=82s', '_blank')">Vídeo Teacher Carlos</button>
            `;
            if (jogo.estado === 'vencido' || jogo.estado === 'perdido') {
                document.getElementById('mensagem').textContent = jogo.estado === 'vencido' ? 'VOCÊ VENCEU!' : `VOCÊ PERDEU! A palavra era: ${jogo.palavra}`;
                botoesFimJogo.innerHTML = botoesHTML;
                botoesFimJogo.style.display = 'grid';
            } else {
                document.getElementById('mensagem').textContent = jogo.palavra ? '' : 'Aguardando palavra do Jogador 1...';
                botoesFimJogo.style.display = 'none';
            }
        }

        async function adivinharLetra() {
            if (papel !== 'jogador2' || jogo.estado !== 'em andamento') return;
            const letra = document.getElementById('letraInput').value.trim().toLowerCase();
            if (!letra || letra.length !== 1 || !/[a-záéíóúâêîôûãõç]/.test(letra)) {
                alert('Digite uma letra válida.');
                document.getElementById('letraInput').value = '';
                document.getElementById('letraInput').focus();
                return;
            }
            const letraNormalizada = normalizarLetra(letra);
            if (jogo.letrasAdivinhadas.some(l => normalizarLetra(l) === letraNormalizada)) {
                const mensagemRepetida = document.getElementById('mensagemLetraRepetida');
                mensagemRepetida.style.display = 'block';
                setTimeout(() => mensagemRepetida.style.display = 'none', 1000);
                document.getElementById('letraInput').value = '';
                document.getElementById('letraInput').focus();
                return;
            }
            jogo.letrasAdivinhadas.push(letra);
            const palavraNormalizada = normalizarPalavra(jogo.palavra);
            if (!palavraNormalizada.includes(letraNormalizada)) {
                jogo.erros += 1;
            }
            const letrasFaltando = palavraNormalizada.split('').filter((l, i) => {
                const letraOriginalNormalizada = normalizarLetra(jogo.palavra[i]);
                return !jogo.letrasAdivinhadas.some(la => normalizarLetra(la) === letraOriginalNormalizada);
            });
            if (letrasFaltando.length === 0) {
                jogo.estado = 'vencido';
                if (modo === 'multiplayer') {
                    const idVencedor = jogo.jogador2;
                    if (!jogo.placar[idVencedor]) jogo.placar[idVencedor] = { vitorias: 0 };
                    jogo.placar[idVencedor].vitorias += 1;
                } else if (modo === 'solo') {
                    if (!jogo.placar.jogador) jogo.placar.jogador = { vitorias: 0 };
                    jogo.placar.jogador.vitorias += 1;
                }
            } else if (jogo.erros >= 6) {
                jogo.estado = 'perdido';
                if (modo === 'multiplayer') {
                    const idVencedor = jogo.jogador1;
                    if (!jogo.placar[idVencedor]) jogo.placar[idVencedor] = { vitorias: 0 };
                    jogo.placar[idVencedor].vitorias += 1;
                } else if (modo === 'solo') {
                    if (!jogo.placar.computador) jogo.placar.computador = { vitorias: 0 };
                    jogo.placar.computador.vitorias += 1;
                }
            }
            if (modo === 'multiplayer') {
                const jogoRef = ref(db, `jogos/${idJogo}`);
                await update(jogoRef, {
                    letrasAdivinhadas: jogo.letrasAdivinhadas,
                    erros: jogo.erros,
                    estado: jogo.estado,
                    placar: jogo.placar
                });
            }
            document.getElementById('letraInput').value = '';
            document.getElementById('letraInput').focus();
        }

        document.getElementById('jogarSozinhoBtn').addEventListener('click', iniciarJogoSolo);
        document.getElementById('jogarComAmigoBtn').addEventListener('click', mostrarOpcoesMultiplayer);
        document.getElementById('criarJogoBtn').addEventListener('click', mostrarCriarJogo);
        document.getElementById('entrarJogoBtn').addEventListener('click', mostrarEntrarJogo);
        document.getElementById('criarJogoSubmitBtn').addEventListener('click', criarJogo);
        document.getElementById('entrarJogoSubmitBtn').addEventListener('click', entrarJogo);
        document.getElementById('letraInput').addEventListener('input', adivinharLetra);
        document.getElementById('palavraInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') criarJogo(); });
        document.getElementById('idJogoInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') entrarJogo(); });
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); enviarMensagem(); } });
        document.getElementById('chatBtn').addEventListener('click', toggleChat);
        document.getElementById('closeChatBtn').addEventListener('click', toggleChat);
        window.jogarNovamente = jogarNovamente;

        mostrarTela('inicial');
    </script>
</body>
</html>
