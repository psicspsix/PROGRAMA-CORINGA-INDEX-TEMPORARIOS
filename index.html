<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Forca</title>
    <link rel="icon" href="https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/psicspsix.ico">
    <style>
        body {
            background-image: url('https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Forca.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #000000;
            color: #ffffff;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            overflow: auto;
        }
        #telaInicial, #telaJogo {
            text-align: center;
            transition: all 0.3s ease;
        }
        #telaInicial {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 600px;
        }
        #telaInicial > div {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
        }
        #telaJogo {
            display: none;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            position: relative;
        }
        #telaJogo.chat-aberto {
            margin-left: -20%;
            max-width: 50%;
        }
        h1, h2 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        h3 {
            font-size: 2em;
            margin: 0;
        }
        button {
            background-color: #333333;
            color: #ffffff;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 5px;
            pointer-events: auto;
            z-index: 1000;
        }
        button:hover {
            background-color: #555555;
        }
        #jogarSozinhoBtn {
            white-space: normal;
            line-height: 1.4;
            padding: 10px 15px;
            width: 180px;
            height: 50px;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        input, textarea {
            font-size: 1.2em;
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            background: #333333;
            color: #ffffff;
            border: 1px solid #555555;
            width: calc(100% - 22px);
        }
        #letraInput {
            width: 50px;
            text-align: center;
        }
        textarea {
            resize: none;
            height: 60px;
            overflow-y: auto;
        }
        #forcaContainer {
            position: relative;
            width: 300px;
            height: 600px;
            margin: 20px auto;
            overflow: hidden;
            border: 2px solid #ffffff;
            background: rgba(0, 0, 0, 0.5);
        }
        #forcaImagem {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: clip-path 0.3s ease;
        }
        #erroImagem {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 16px;
            text-align: center;
            display: none;
        }
        #forcaImagem.erro-0 { clip-path: inset(100% 0 0 0); }
        #forcaImagem.erro-1 { clip-path: inset(0 0 80% 0); }
        #forcaImagem.erro-2 { clip-path: inset(0 0 60% 0); }
        #forcaImagem.erro-3 { clip-path: inset(0 0 50% 0); }
        #forcaImagem.erro-4 { clip-path: inset(0 0 40% 0); }
        #forcaImagem.erro-5 { clip-path: inset(0 0 20% 0); }
        #forcaImagem.erro-6 { clip-path: inset(0 0 0 0); }
        #palavra, #palavraJogador1 {
            font-size: 24px;
            margin: 20px 0;
        }
        #palavraTopo {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            font-size: 24px;
        }
        #mensagem {
            font-size: 18px;
            color: #ffff00;
        }
        #mensagemLetraRepetida {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ff0000;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            text-align: center;
        }
        #exemploFrases {
            font-size: 16px;
            margin-top: 10px;
        }
        #placar {
            font-size: 16px;
            margin-top: 10px;
        }
        #jogador1View, #jogador2View {
            margin-bottom: 20px;
        }
        #participanteEsquerda, #participanteDireita {
            position: absolute;
            top: 80px;
            text-align: center;
            z-index: 1000;
        }
        #participanteEsquerda {
            left: -260px;
        }
        #participanteDireita {
            right: -260px;
        }
        #participanteEsquerda h3, #participanteDireita h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        #participanteEsquerda p, #participanteDireita p {
            font-size: 1.5em;
            margin: 0;
        }
        #chatContainer {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 30%;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            z-index: 999;
        }
        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #555555;
            border-radius: 5px;
        }
        #chatInputContainer {
            display: flex;
            flex-direction: column;
        }
        #chatBtn {
            background-color: #444444;
            padding: 10px 20px;
            z-index: 1000;
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
        }
        #closeChatBtn {
            background-color: #444444;
            padding: 10px 20px;
            z-index: 1000;
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: none;
        }
        #chatInput {
            resize: none;
            height: 60px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .mensagem {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
        }
        .mensagem.jogador1 {
            background-color: #555555;
            text-align: left;
        }
        .mensagem.jogador2 {
            background-color: #777777;
            text-align: right;
        }
        #botoesFimJogo {
            display: none;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        #botoesFimJogo button {
            padding: 10px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <div id="telaInicial">
        <h1>Jogo de Forca</h1>
        <div>
            <button id="jogarSozinhoBtn">Jogar Sozinho (Palavras em Inglês)</button>
            <button id="jogarComAmigoBtn">Jogar com Amigo</button>
        </div>
        <div id="opcoesMultiplayer" style="display: none;">
            <button id="criarJogoBtn">Criar Jogo</button>
            <button id="entrarJogoBtn">Entrar em Jogo</button>
        </div>
        <div id="criarJogo" style="display: none;">
            <input type="text" id="palavraInput" placeholder="Digite a palavra">
            <button id="criarJogoSubmitBtn">Criar</button>
        </div>
        <div id="entrarJogo" style="display: none;">
            <input type="text" id="idJogoInput" placeholder="Digite o ID do jogo">
            <button id="entrarJogoSubmitBtn">Entrar</button>
        </div>
    </div>
    <div id="telaJogo">
        <p id="palavraTopo"></p>
        <div id="jogador1View" style="display: none;">
            <h2>Aguardando o amigo adivinhar...</h2>
            <p>Palavra: <span id="palavraJogador1"></span></p>
            <p>Letras já escolhidas: <span id="letrasAdivinhadasJogador1"></span></p>
        </div>
        <div id="jogador2View" style="display: none;">
            <h2>Adivinhe a palavra</h2>
            <p id="palavra"></p>
            <input type="text" id="letraInput" maxlength="1" placeholder="Digite uma letra">
        </div>
        <div id="participanteEsquerda">
            <h3 id="nomeEsquerda"></h3>
            <p id="pontosEsquerda"></p>
        </div>
        <div id="participanteDireita">
            <h3 id="nomeDireita"></h3>
            <p id="pontosDireita"></p>
        </div>
        <div id="forcaContainer">
            <img id="forcaImagem" src="https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo.jpg" alt="Imagem da forca" onload="console.log('Imagem carregada:', this.src); document.getElementById('erroImagem').style.display = 'none';" onerror="console.error('Erro ao carregar imagem:', this.src); document.getElementById('erroImagem').style.display = 'block';">
            <div id="erroImagem">Erro: Não foi possível carregar a imagem.</div>
        </div>
        <div id="mensagemLetraRepetida">Letra já digitada!</div>
        <p id="mensagem"></p>
        <p id="exemploFrases"></p>
        <p id="placar"></p>
        <div id="botoesFimJogo"></div>
    </div>
    <button id="chatBtn">Abrir Chat</button>
    <button id="closeChatBtn" style="display: none;">Fechar Chat</button>
    <div id="chatContainer">
        <div id="chatMessages"></div>
        <div id="chatInputContainer">
            <textarea id="chatInput" placeholder="Digite sua mensagem..."></textarea>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDYju4ux-XrvEXaP2aSXbY2eJd_Qj4AKow",
            authDomain: "jogo-de-forca-b905b.firebaseapp.com",
            databaseURL: "https://jogo-de-forca-b905b-default-rtdb.firebaseio.com",
            projectId: "jogo-de-forca-b905b",
            storageBucket: "jogo-de-forca-b905b.firebasestorage.app",
            messagingSenderId: "18562245618",
            appId: "1:18562245618:web:f73368efe7b2b4a97fc16b",
            measurementId: "G-WMMXLXSY1R"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let modo = '';
        let papel = '';
        let idJogo = '';
        let jogadorId = Math.random().toString(36).substr(2, 9);
        let jogo = {
            palavra: '',
            letrasAdivinhadas: [],
            erros: 0,
            estado: 'em andamento',
            frases: [],
            chatAberto: false,
            jogador1: '',
            jogador2: '',
            jogador1Inicial: '',
            jogador2Inicial: '',
            placar: {}
        };
        let unsubscribeJogo = null;
        let unsubscribeChat = null;
        let chatAberto = false;
        const imagemOriginal = 'https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo.jpg';
        const imagemDerrota = 'https://raw.githubusercontent.com/psicspsix/Jogo-de-Forca/main/Lorca-Corpo-Completo-Enforcado.jpg';

        function normalizarLetra(letra) {
            if (!letra) return letra;
            return letra.toLowerCase()
                .replace(/[áàâã]/g, 'a')
                .replace(/[éèê]/g, 'e')
                .replace(/[íìî]/g, 'i')
                .replace(/[óòôõ]/g, 'o')
                .replace(/[úùû]/g, 'u')
                .replace(/[ç]/g, 'c');
        }

        function normalizarPalavra(palavra) {
            return palavra.split('').map(normalizarLetra).join('');
        }

        function mostrarTela(tela) {
            const telaInicial = document.getElementById('telaInicial');
            const telaJogo = document.getElementById('telaJogo');
            const chatContainer = document.getElementById('chatContainer');
            const chatBtn = document.getElementById('chatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');

            telaInicial.style.display = 'none';
            telaJogo.style.display = 'none';
            chatContainer.style.display = 'none';
            chatBtn.style.display = 'none';
            closeChatBtn.style.display = 'none';

            if (tela === 'inicial') {
                telaInicial.style.display = 'flex';
                document.getElementById('opcoesMultiplayer').style.display = 'none';
                document.getElementById('criarJogo').style.display = 'none';
                document.getElementById('entrarJogo').style.display = 'none';
                if (unsubscribeJogo) {
                    unsubscribeJogo();
                    unsubscribeJogo = null;
                }
                if (unsubscribeChat) {
                    unsubscribeChat();
                    unsubscribeChat = null;
                }
                if (modo !== 'multiplayer') {
                    jogo.placar = {};
                    console.log('Tela inicial exibida: #telaInicial=flex, #chatBtn=none, #chatContainer=none, placar reiniciado (modo solo)');
                } else {
                    console.log('Tela inicial exibida: #telaInicial=flex, #chatBtn=none, #chatContainer=none, placar mantido (modo multiplayer)', jogo.placar);
                }
            } else if (tela === 'jogo') {
                telaJogo.style.display = 'block';
                if (modo === 'multiplayer') {
                    chatBtn.style.display = chatAberto ? 'none' : 'block';
                    closeChatBtn.style.display = chatAberto ? 'block' : 'none';
                    chatContainer.style.display = chatAberto ? 'flex' : 'none';
                }
                if (papel === 'jogador2' && jogo.estado === 'em andamento') {
                    document.getElementById('letraInput').focus();
                    console.log('Foco definido em letraInput (mostrarTela)');
                }
                console.log(`Tela jogo exibida: modo=${modo}, chatAberto=${chatAberto}, #chatBtn=${chatBtn.style.display}, #chatContainer=${chatContainer.style.display}`);
            }
        }

        function mostrarOpcoesMultiplayer() {
            document.getElementById('opcoesMultiplayer').style.display = 'flex';
            document.getElementById('criarJogo').style.display = 'none';
            document.getElementById('entrarJogo').style.display = 'none';
        }

        function mostrarCriarJogo() {
            document.getElementById('opcoesMultiplayer').style.display = 'none';
            document.getElementById('criarJogo').style.display = 'block';
            document.getElementById('entrarJogo').style.display = 'none';
            document.getElementById('palavraInput').focus();
            document.getElementById('palavraInput').value = '';
        }

        function mostrarEntrarJogo() {
            document.getElementById('opcoesMultiplayer').style.display = 'none';
            document.getElementById('entrarJogo').style.display = 'block';
            document.getElementById('criarJogo').style.display = 'none';
            document.getElementById('idJogoInput').focus();
        }

        function toggleChat() {
            chatAberto = !chatAberto;
            const telaJogo = document.getElementById('telaJogo');
            const chatContainer = document.getElementById('chatContainer');
            const chatBtn = document.getElementById('chatBtn');
            const closeChatBtn = document.getElementById('closeChatBtn');
            const participanteEsquerda = document.getElementById('participanteEsquerda');
            const participanteDireita = document.getElementById('participanteDireita');
            const placar = document.getElementById('placar');
            if (chatAberto) {
                telaJogo.classList.add('chat-aberto');
                chatContainer.style.display = 'flex';
                chatBtn.style.display = 'none';
                closeChatBtn.style.display = 'block';
                if (modo === 'multiplayer') {
                    participanteEsquerda.style.display = 'none';
                    participanteDireita.style.display = 'none';
                    placar.style.display = 'none';
                }
                document.getElementById('chatInput').focus();
                update(ref(db, `jogos/${idJogo}`), { chatAberto: true });
            } else {
                telaJogo.classList.remove('chat-aberto');
                chatContainer.style.display = 'none';
                chatBtn.style.display = 'block';
                closeChatBtn.style.display = 'none';
                if (modo === 'multiplayer') {
                    participanteEsquerda.style.display = 'block';
                    participanteDireita.style.display = 'block';
                    placar.style.display = 'block';
                }
                if (papel === 'jogador2' && jogo.estado === 'em andamento') {
                    document.getElementById('letraInput').focus();
                    console.log('Foco definido em letraInput (toggleChat)');
                }
            }
            console.log(`Chat toggled: chatAberto=${chatAberto}, #chatContainer=${chatContainer.style.display}`);
        }

        async function enviarMensagem() {
            const mensagem = document.getElementById('chatInput').value.trim();
            if (!mensagem) return;
            try {
                const chatRef = ref(db, `jogos/${idJogo}/chat`);
                await push(chatRef, {
                    remetente: papel,
                    texto: mensagem,
                    timestamp: Date.now()
                });
                document.getElementById('chatInput').value = '';
                document.getElementById('chatInput').focus();
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem: ' + error.message);
            }
        }

        function exibirMensagens(snapshot) {
            const mensagens = snapshot.val();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            if (mensagens) {
                Object.values(mensagens)
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `mensagem ${msg.remetente}`;
                        div.textContent = `${msg.remetente.charAt(0).toUpperCase() + msg.remetente.slice(1)}: ${msg.texto}`;
                        chatMessages.appendChild(div);
                    });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        async function iniciarJogoSolo() {
            modo = 'solo';
            papel = 'jogador2';
            jogo.placar = { jogador: { vitorias: 0 }, computador: { vitorias: 0 } };
            await carregarNovaPalavra();
            mostrarTela('jogo');
            exibirJogo();
            document.getElementById('letraInput').focus();
            console.log('Foco definido em letraInput (iniciarJogoSolo), placar inicial:', jogo.placar);
        }

        async function jogarNovamente() {
            console.log('[jogarNovamente] Iniciando: modo=', modo, 'placar antes=', JSON.stringify(jogo.placar));
            const imagemForca = document.getElementById('forcaImagem');
            imagemForca.src = imagemOriginal;
            imagemForca.className = 'erro-0';
            if (modo === 'solo') {
                await carregarNovaPalavra();
                exibirJogo();
                document.getElementById('letraInput').focus();
                console.log('Foco definido em letraInput (jogarNovamente, solo), placar mantido:', jogo.placar);
                document.getElementById('telaJogo').scrollIntoView({ behavior: 'smooth' });
            } else if (modo === 'multiplayer') {
                try {
                    const jogoRef = ref(db, `jogos/${idJogo}`);
                    const snapshot = await get(jogoRef);
                    if (!snapshot.exists()) {
                        alert('O jogo não existe mais.');
                        mostrarTela('inicial');
                        return;
                    }
                    const jogoAtual = snapshot.val();
                    if (jogoAtual.estado === 'reiniciando') {
                        console.log('Jogo já está sendo reiniciado por outro jogador.');
                        return;
                    }
                    await update(jogoRef, { estado: 'reiniciando' });
                    const novoJogador1 = jogo.jogador2;
                    const novoJogador2 = jogo.jogador1;
                    const placarAtual = jogo.placar;
                    jogo = validateJogo({
                        palavra: '',
                        letrasAdivinhadas: [],
                        erros: 0,
                        estado: 'aguardando_palavra',
                        frases: [],
                        chatAberto: false,
                        jogador1: novoJogador1,
                        jogador2: novoJogador2,
                        jogador1Inicial: jogo.jogador1Inicial || jogo.jogador1,
                        jogador2Inicial: jogo.jogador2Inicial || jogo.jogador2,
                        placar: placarAtual
                    });
                    await set(jogoRef, jogo);
                    await set(ref(db, `jogos/${idJogo}/chat`), null);
                    papel = jogadorId === novoJogador1 ? 'jogador1' : 'jogador2';
                    console.log(`[jogarNovamente] Papéis invertidos: jogadorId=${jogadorId}, novo papel=${papel}, placar após reinício=`, JSON.stringify(jogo.placar));
                    if (papel === 'jogador1') {
                        mostrarTela('inicial');
                        mostrarCriarJogo();
                    } else {
                        alert('Aguardando o Jogador 1 escolher uma nova palavra.');
                        mostrarTela('jogo');
                        exibirJogo();
                        document.getElementById('letraInput').focus();
                        console.log('Foco definido em letraInput (jogarNovamente, multiplayer, jogador2)');
                    }
                    await update(jogoRef, { estado: 'aguardando_palavra' });
                } catch (error) {
                    console.error('Erro ao reiniciar jogo:', error);
                    alert('Erro ao reiniciar jogo: ' + error.message);
                }
            }
        }

        async function carregarNovaPalavra() {
            try {
                const palavrasRef = ref(db, 'palavras');
                const snapshot = await get(palavrasRef);
                const palavras = snapshot.val();
                if (!palavras || Object.keys(palavras).length === 0) {
                    alert('Nenhuma palavra encontrada no banco de dados.');
                    return;
                }
                const palavrasArray = Object.values(palavras);
                const palavraAleatoria = palavrasArray[Math.floor(Math.random() * palavrasArray.length)];
                const placarAtual = jogo.placar || { jogador: { vitorias: 0 }, computador: { vitorias: 0 } };
                jogo = {
                    palavra: palavraAleatoria.palavra.toLowerCase(),
                    letrasAdivinhadas: [],
                    erros: 0,
                    estado: 'em andamento',
                    frases: palavraAleatoria.flexoes && palavraAleatoria.flexoes.length > 0
                        ? [`Flexões: ${palavraAleatoria.flexoes.join(', ')}`]
                        : [`Frequência: ${palavraAleatoria.frequencia}`],
                    chatAberto: false,
                    jogador1: '',
                    jogador2: '',
                    jogador1Inicial: '',
                    jogador2Inicial: '',
                    placar: placarAtual
                };
                const imagemForca = document.getElementById('forcaImagem');
                imagemForca.src = imagemOriginal;
                imagemForca.className = 'erro-0';
                console.log('Nova palavra carregada, placar mantido:', jogo.placar);
            } catch (error) {
                console.error('Erro ao carregar palavra:', error);
                alert('Erro ao carregar palavras do banco de dados.');
            }
        }

        async function criarJogo() {
            const palavra = document.getElementById('palavraInput
